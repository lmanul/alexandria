<!DOCTYPE html>  <html> <head>   <title>ebook.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="plugins.html">                 plugins.js               </a>                                           <a class="source" href="web_plugins.html">                 web_plugins.js               </a>                                           <a class="source" href="alternate_style_tag_selector.html">                 alternate_style_tag_selector.js               </a>                                           <a class="source" href="audioClipPlayer.html">                 audioClipPlayer.js               </a>                                           <a class="source" href="ebook.html">                 ebook.js               </a>                                           <a class="source" href="manifest_item.html">                 manifest_item.js               </a>                                           <a class="source" href="mediaOverlay.html">                 mediaOverlay.js               </a>                                           <a class="source" href="options_presenter.html">                 options_presenter.js               </a>                                           <a class="source" href="packageDocument.html">                 packageDocument.js               </a>                                           <a class="source" href="paginator.html">                 paginator.js               </a>                                           <a class="source" href="path_resolver.html">                 path_resolver.js               </a>                                           <a class="source" href="readium_options.html">                 readium_options.js               </a>                                           <a class="source" href="smilModel.html">                 smilModel.js               </a>                                           <a class="source" href="toc.html">                 toc.js               </a>                                           <a class="source" href="trigger.html">                 trigger.js               </a>                                           <a class="source" href="crx_library_namespace.html">                 crx_library_namespace.js               </a>                                           <a class="source" href="crx_viewer_namespace.html">                 crx_viewer_namespace.js               </a>                                           <a class="source" href="ws_lib_namespace.html">                 ws_lib_namespace.js               </a>                                           <a class="source" href="crx_library_router.html">                 crx_library_router.js               </a>                                           <a class="source" href="crx_viewer_router.html">                 crx_viewer_router.js               </a>                                           <a class="source" href="ws_router.html">                 ws_router.js               </a>                                           <a class="source" href="bb_file_system_sync.html">                 bb_file_system_sync.js               </a>                                           <a class="source" href="cookie_utils.html">                 cookie_utils.js               </a>                                           <a class="source" href="local_storage_sync.html">                 local_storage_sync.js               </a>                                           <a class="source" href="md5.html">                 md5.js               </a>                                           <a class="source" href="user_agent_utils.html">                 user_agent_utils.js               </a>                                           <a class="source" href="nav_widget_view.html">                 nav_widget_view.js               </a>                                           <a class="source" href="options_view.html">                 options_view.js               </a>                                           <a class="source" href="toc_view.html">                 toc_view.js               </a>                                           <a class="source" href="toolbar_view.html">                 toolbar_view.js               </a>                                           <a class="source" href="httpFileApi.html">                 httpFileApi.js               </a>                                           <a class="source" href="library.html">                 library.js               </a>                                           <a class="source" href="viewer.html">                 viewer.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               ebook.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>Welcome the Annotated Readium Souce Code</strong> </p>

<p>The content on these pages is generated directly from the comments in
Readium's souce code using a tool called <a href="http://jashkenas.github.com/docco/">docco</a>.
At the moment it is a bit of a work in progress but we are working hard
generate some comprehensive documentation for Readium.</p>

<h1>Ebook</h1>

<p>The <strong>Ebook</strong> class is the main buisness object used for maintaining
application state in the Readium viewer.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Ebook</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>capture context for use in callback functions</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
		</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>create a <a href="/docs/paginator.html"><code>Paginator</code></a> object used to initialize
pagination strategies for the spine items of this book</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">paginator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">({</span><span class="nx">book</span><span class="o">:</span> <span class="k">this</span><span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>intantiate a <a href="/docs/packageDocument.html"><code>PackageDocument</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PackageDocument</span><span class="p">({</span> <span class="nx">book</span><span class="o">:</span> <span class="nx">that</span> <span class="p">},</span> <span class="p">{</span>
			<span class="nx">file_path</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;package_doc_path&quot;</span><span class="p">)</span>
		<span class="p">});</span>
		</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>load the <code>packageDocument</code> from the HTML5 filesystem asynchroniously</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>success callback is executed once the filesSystem contents have 
been read and parsed</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>restore the position the reader left off at from cookie storage</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">restorePosition</span><span class="p">();</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>tell the paginator to start rendering spine items from the 
freshly restored position</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">items</span><span class="p">);</span>
				</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>check if a TOC is specified in the <code>packageDocument</code></p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;has_toc&quot;</span><span class="p">,</span> <span class="p">(</span> <span class="o">!!</span><span class="nx">that</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getTocItem</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>if content reflows and the number of pages in the section changes
we need to adjust the the current page</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:num_pages&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">adjustCurrentPage</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>change:spine_position</code> is triggered whenver the reader turns pages
accross a <code>spine_item</code> boundary. We need to cache thier new position
and </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:spine_position&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">savePosition</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If a new fixed layout </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:spine_position&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">save</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>TODO: this should be done properly with a backbone sync</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">ops</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
		<span class="p">}</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ops</span><span class="p">,</span><span class="nx">options</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
		<span class="nx">Lawnchair</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">ops</span><span class="p">.</span><span class="nx">success</span><span class="p">);</span>
		<span class="p">});</span>
	<span class="p">},</span>

	<span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
		<span class="s2">&quot;font_size&quot;</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    	<span class="s2">&quot;current_page&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    	<span class="s2">&quot;num_pages&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    	<span class="s2">&quot;two_up&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;full_screen&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;toolbar_visible&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    	<span class="s2">&quot;toc_visible&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;can_two_up&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    	<span class="s2">&quot;rendered_spine_items&quot;</span><span class="o">:</span> <span class="p">[],</span>
    	<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="s2">&quot;default-theme&quot;</span><span class="p">,</span>
    	<span class="s2">&quot;current_margin&quot;</span><span class="o">:</span> <span class="mi">3</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>"spine_position": 0</p>             </td>             <td class="code">               <div class="highlight"><pre>  	<span class="p">},</span>

  	<span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>only save attrs that should be persisted:</p>             </td>             <td class="code">               <div class="highlight"><pre>  		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;apple_fixed&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;apple_fixed&quot;</span><span class="p">),</span>
			<span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">),</span>
			<span class="s2">&quot;cover_href&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;cover_href&quot;</span><span class="p">),</span>
			<span class="s2">&quot;created_at&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
			<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_theme&quot;</span><span class="p">),</span>
			<span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
			<span class="s2">&quot;epub_version&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epub_version&quot;</span><span class="p">),</span>
			<span class="s2">&quot;fixed_layout&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;fixed_layout&quot;</span><span class="p">),</span>
			<span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
			<span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">),</span>
			<span class="s2">&quot;language&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">),</span>
			<span class="s2">&quot;layout&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">),</span>
			<span class="s2">&quot;modified_date&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;modified_date&quot;</span><span class="p">),</span>
			<span class="s2">&quot;ncx&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;ncx&quot;</span><span class="p">),</span>
			<span class="s2">&quot;open_to_spread&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;open_to_spread&quot;</span><span class="p">),</span>
			<span class="s2">&quot;orientation&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;orientation&quot;</span><span class="p">),</span>
			<span class="s2">&quot;package_doc_path&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;package_doc_path&quot;</span><span class="p">),</span>
			<span class="s2">&quot;page_prog_dir&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;page_prog_dir&quot;</span><span class="p">),</span>
			<span class="s2">&quot;paginate_backwards&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;paginate_backwards&quot;</span><span class="p">),</span>
			<span class="s2">&quot;pubdate&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pubdate&quot;</span><span class="p">),</span>
			<span class="s2">&quot;publisher&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;publisher&quot;</span><span class="p">),</span>
			<span class="s2">&quot;rights&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rights&quot;</span><span class="p">),</span>
			<span class="s2">&quot;spread&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spread&quot;</span><span class="p">),</span>
			<span class="s2">&quot;src_url&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;src_url&quot;</span><span class="p">),</span>
			<span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
			<span class="s2">&quot;updated_at&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">),</span>
			<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_theme&quot;</span><span class="p">),</span>
			<span class="s2">&quot;current_margin&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_margin&quot;</span><span class="p">),</span>
			<span class="s2">&quot;font_size&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">),</span>
			<span class="s2">&quot;two_up&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">)</span>
		<span class="p">};</span>
	<span class="p">},</span>

	<span class="nx">toggleTwoUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;can_two_up&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="kr">debugger</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">twoUp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">displayed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">newPages</span> <span class="o">=</span> <span class="p">[];</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">twoUp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">newPages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">newPages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentSection</span><span class="p">().</span><span class="nx">isFixedLayout</span><span class="p">())</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">newPages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="nx">newPages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="nx">newPages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="nx">newPages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">newPages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="nx">newPages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="nx">newPages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">newPages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">displayed</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">two_up</span><span class="o">:</span> <span class="o">!</span><span class="nx">twoUp</span><span class="p">,</span> <span class="nx">current_page</span><span class="o">:</span> <span class="nx">newPages</span><span class="p">});</span>
		<span class="p">}</span>	
	<span class="p">},</span>

	<span class="nx">toggleFullScreen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">fullScreen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;full_screen&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">full_screen</span><span class="o">:</span> <span class="o">!</span><span class="nx">fullScreen</span><span class="p">});</span>
	<span class="p">},</span>

	<span class="nx">increaseFont</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">font_size</span><span class="o">:</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
	<span class="p">},</span>

	<span class="nx">decreaseFont</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">font_size</span><span class="o">:</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
	<span class="p">},</span>

	<span class="nx">toggleToc</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;toc_visible&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;toc_visible&quot;</span><span class="p">,</span> <span class="o">!</span><span class="nx">vis</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>turn pages in the rightward direction
ie progression direction is dependent on 
page progression dir</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">goRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;page_prog_dir&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;rtl&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">prevPage</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">nextPage</span><span class="p">();</span>	
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>turn pages in the leftward direction
ie progression direction is dependent on 
page progression dir</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">goLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;page_prog_dir&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;rtl&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">nextPage</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">prevPage</span><span class="p">();</span>	
		<span class="p">}</span>
	<span class="p">},</span>
	
	<span class="nx">prevPage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">curr_pg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">lastPage</span> <span class="o">=</span> <span class="nx">curr_pg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="nx">curr_pg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">goToPrevSection</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">)){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">lastPage</span><span class="p">]);</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">)[</span><span class="nx">lastPage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">lastPage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">lastPage</span><span class="p">]);</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

				<span class="kd">var</span> <span class="nx">ind</span> <span class="o">=</span> <span class="p">(</span><span class="nx">lastPage</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">lastPage</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
				<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">)[</span><span class="nx">ind</span><span class="p">];</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	
	<span class="nx">nextPage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">curr_pg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">firstPage</span> <span class="o">=</span> <span class="nx">curr_pg</span><span class="p">[</span><span class="nx">curr_pg</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">curr_pg</span><span class="p">[</span><span class="nx">curr_pg</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;num_pages&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">goToNextSection</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">)){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">firstPage</span><span class="p">]);</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">)[</span><span class="nx">firstPage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">firstPage</span><span class="p">,</span> <span class="nx">firstPage</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">)[</span><span class="nx">firstPage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">goToLastPage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;num_pages&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">goToPage</span><span class="p">(</span><span class="nx">page</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">goToPage</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>in two up mode we need to keep track of what side
of the spine the odd pages go on</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentSection</span><span class="p">().</span><span class="nx">isFixedLayout</span><span class="p">())</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">page</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// this logic needs to be smartened up</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">page</span><span class="p">,</span> <span class="nx">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>	
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">page</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>in reflowable format, we want this config always:
ODD<em>PAGE |spine| EVEN</em>PAGE</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="nx">page</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">page</span><span class="p">,</span> <span class="nx">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>	
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">page</span><span class="p">]);</span>
				<span class="p">}</span>	
			<span class="p">}</span>
			
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">page</span><span class="p">])</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">restorePosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">getCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">savePosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">Readium</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">),</span> <span class="mi">365</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">resolvePath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">adjustCurrentPage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">num</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;num_pages&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">two_up</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">cp</span><span class="p">[</span><span class="nx">cp</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">goToLastPage</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">},</span>	
	
	<span class="nx">goToNextSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Is this check even necessary?
I think package doc validations takes care of it</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasNextSection</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	
	<span class="nx">goToPrevSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Is this check even necessary?
I think package doc validations takes care of it</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPrevSection</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePosBackwards</span><span class="p">(</span><span class="nx">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>	
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">hasNextSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineLength</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">hasPrevSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">setSpinePos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineLength</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>invalid position</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">spineItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">spineItems</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>the spine item is already on the page</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">spineItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>we are in fixed layout state, one spine item per page</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">this</span><span class="p">.</span><span class="nx">goToPage</span><span class="p">(</span><span class="nx">spineItems</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>else nothing to do, because the section is already rendered out</p>             </td>             <td class="code">               <div class="highlight"><pre>			
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>the section is not rendered out, need to do so</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">items</span><span class="p">);</span>	
		<span class="p">}</span>
		
	<span class="p">},</span>

	<span class="nx">setSpinePosBackwards</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineLength</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>invalid position</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>the spine item is already on the page, nothing to do</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">items</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">goToHref</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>URL's with hash fragments require special treatment, so
firs thing is to split off the hash frag from the reset
of the url:</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">splitUrl</span> <span class="o">=</span> <span class="nx">href</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([^#]*)(?:#(.*))?/</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>handle the base url first:</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">spine_pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineIndexFromHref</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">spine_pos</span><span class="p">);</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>now try to handle the fragment if there was one,</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>just set observable property to broadcast event
to anyone who cares</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">hash_fragment</span><span class="o">:</span> <span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]});</span>
		<span class="p">}</span>
		
	<span class="p">},</span>

	<span class="nx">changPageNumber</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_page&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">np</span> <span class="o">=</span> <span class="p">[];</span>
		<span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">num</span> <span class="o">-</span> <span class="nx">cp</span><span class="p">[</span><span class="nx">cp</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span> <span class="nx">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">np</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">;</span>	
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">num_pages</span><span class="o">:</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">current_page</span><span class="o">:</span> <span class="nx">np</span><span class="p">});</span>
	<span class="p">},</span>

	<span class="nx">getToc</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getTocItem</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Toc</span><span class="p">.</span><span class="nx">getToc</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="p">{</span>
				<span class="nx">file_path</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)),</span>
				<span class="nx">book</span><span class="o">:</span> <span class="nx">that</span>
			<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">setMetaSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;change:meta_height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentSection</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;meta_size&quot;</span><span class="p">,</span> <span class="p">{</span>
				<span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_width&quot;</span><span class="p">),</span>
				<span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">)</span>
			<span class="p">});</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:meta_height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>when the spine position changes we need to update the
state of this, this involes setting attributes that reflect
the current section's url and content etc, and then we need
to persist the position in a cookie</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">spinePositionChangedHandler</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">sect</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentSection</span><span class="p">();</span>
		<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">sect</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">resolveUri</span><span class="p">(</span><span class="nx">path</span><span class="p">);;</span>
		<span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_section_url&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
		<span class="nx">Readium</span><span class="p">.</span><span class="nx">FileSystemApi</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">api</span><span class="p">.</span><span class="nx">readTextFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span><span class="nx">current_content</span><span class="o">:</span> <span class="nx">result</span><span class="p">}</span> <span class="p">);</span>
			<span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Failed to load file: &quot;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">);</span>
			<span class="p">})</span>
		<span class="p">});</span>
		</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>save the position</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">savePosition</span><span class="p">();</span>
	<span class="p">},</span>

	<span class="nx">getCurrentSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">spine_pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getSpineItem</span><span class="p">(</span><span class="nx">spine_pos</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">playMo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">forceFromStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">mo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentSection</span><span class="p">().</span><span class="nx">getMediaOverlay</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">mo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;mo_playing&quot;</span><span class="p">,</span> <span class="nx">mo</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="nx">mo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:current_text_document_url&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">goToHref</span><span class="p">(</span><span class="nx">mo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_text_document_url&quot;</span><span class="p">));</span>
			<span class="p">});</span>
			<span class="nx">mo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:current_text_element_id&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">frag</span> <span class="o">=</span> <span class="nx">mo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_text_element_id&quot;</span><span class="p">)</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;hash_fragment&quot;</span><span class="p">,</span> <span class="nx">frag</span><span class="p">);</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;current_mo_frag&quot;</span><span class="p">,</span> <span class="nx">frag</span><span class="p">);</span>
			<span class="p">});</span>
            <span class="nx">mo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:is_document_done&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">pauseMo</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>advance the spine position</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">hasNextSection</span><span class="p">())</span> <span class="p">{</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">goToNextSection</span><span class="p">();</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">playMo</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">mo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;has_started_playback&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">forceFromStart</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mo</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">mo</span><span class="p">.</span><span class="nx">startPlayback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
            <span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Sorry, the current EPUB does not contain a media overlay for this content&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">pauseMo</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">mo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;mo_playing&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">mo</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">mo</span><span class="p">.</span><span class="nx">off</span><span class="p">();</span>
			<span class="nx">mo</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;mo_playing&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>is this book set to fixed layout at the meta-data level</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">isFixedLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;fixed_layout&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;apple_fixed&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 