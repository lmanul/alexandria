<!DOCTYPE html>  <html> <head>   <title>manifest_item.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="plugins.html">                 plugins.js               </a>                                           <a class="source" href="web_plugins.html">                 web_plugins.js               </a>                                           <a class="source" href="alternate_style_tag_selector.html">                 alternate_style_tag_selector.js               </a>                                           <a class="source" href="audioClipPlayer.html">                 audioClipPlayer.js               </a>                                           <a class="source" href="epub.html">                 epub.js               </a>                                           <a class="source" href="epub_controller.html">                 epub_controller.js               </a>                                           <a class="source" href="ibooks_options_parser.html">                 ibooks_options_parser.js               </a>                                           <a class="source" href="manifest_item.html">                 manifest_item.js               </a>                                           <a class="source" href="mediaOverlay.html">                 mediaOverlay.js               </a>                                           <a class="source" href="options_presenter.html">                 options_presenter.js               </a>                                           <a class="source" href="packageDocument.html">                 packageDocument.js               </a>                                           <a class="source" href="package_document_parser.html">                 package_document_parser.js               </a>                                           <a class="source" href="page_number_display_logic.html">                 page_number_display_logic.js               </a>                                           <a class="source" href="pagination_strategy_selector.html">                 pagination_strategy_selector.js               </a>                                           <a class="source" href="path_resolver.html">                 path_resolver.js               </a>                                           <a class="source" href="readium_options.html">                 readium_options.js               </a>                                           <a class="source" href="readium_pagination.html">                 readium_pagination.js               </a>                                           <a class="source" href="smilModel.html">                 smilModel.js               </a>                                           <a class="source" href="toc.html">                 toc.js               </a>                                           <a class="source" href="trigger.html">                 trigger.js               </a>                                           <a class="source" href="validated_package_meta_data.html">                 validated_package_meta_data.js               </a>                                           <a class="source" href="crx_library_namespace.html">                 crx_library_namespace.js               </a>                                           <a class="source" href="crx_viewer_namespace.html">                 crx_viewer_namespace.js               </a>                                           <a class="source" href="ws_lib_namespace.html">                 ws_lib_namespace.js               </a>                                           <a class="source" href="crx_library_router.html">                 crx_library_router.js               </a>                                           <a class="source" href="crx_viewer_router.html">                 crx_viewer_router.js               </a>                                           <a class="source" href="ws_router.html">                 ws_router.js               </a>                                           <a class="source" href="bb_file_system_sync.html">                 bb_file_system_sync.js               </a>                                           <a class="source" href="cookie_utils.html">                 cookie_utils.js               </a>                                           <a class="source" href="handlebars_helpers.html">                 handlebars_helpers.js               </a>                                           <a class="source" href="local_storage_sync.html">                 local_storage_sync.js               </a>                                           <a class="source" href="md5.html">                 md5.js               </a>                                           <a class="source" href="user_agent_utils.html">                 user_agent_utils.js               </a>                                           <a class="source" href="nav_widget_view.html">                 nav_widget_view.js               </a>                                           <a class="source" href="options_view.html">                 options_view.js               </a>                                           <a class="source" href="toc_view.html">                 toc_view.js               </a>                                           <a class="source" href="toolbar_view.html">                 toolbar_view.js               </a>                                           <a class="source" href="httpFileApi.html">                 httpFileApi.js               </a>                                           <a class="source" href="library.html">                 library.js               </a>                                           <a class="source" href="viewer.html">                 viewer.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               manifest_item.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ManifestItem</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
	
	<span class="nx">parseMetaTags</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		 <span class="kd">var</span> <span class="nx">pageSize</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>only need to go through this one time, so only parse it
if it is not already known</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_width&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isSvg</span><span class="p">())</span> <span class="p">{</span>
			<span class="nx">pageSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseViewboxTag</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isImage</span><span class="p">())</span> <span class="p">{</span>
			<span class="nx">pageSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseViewportTag</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="nx">pageSize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s2">&quot;meta_width&quot;</span><span class="o">:</span> <span class="nx">pageSize</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="s2">&quot;meta_height&quot;</span><span class="o">:</span> <span class="nx">pageSize</span><span class="p">.</span><span class="nx">height</span><span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">getContentDom</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">DOMParser</span><span class="p">();</span>
			<span class="k">return</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">parseFromString</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="s1">&#39;text/xml&#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>for fixed layout xhtml we need to parse the meta viewport
tag to determine the size of the pages. more info in the 
<a href="http://idpf.org/epub/fxl/#dimensions-xhtml-svg">fixed layout spec</a></p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">parseViewportTag</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">dom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContentDom</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">viewportTag</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s2">&quot;viewport&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">viewportTag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>this is going to be ugly</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">viewportTag</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
		<span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">valuePairs</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="kd">var</span> <span class="nx">pair</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">valuePairs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">pair</span> <span class="o">=</span> <span class="nx">valuePairs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">pair</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">values</span><span class="p">[</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nx">values</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
		<span class="nx">values</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>for fixed layout svg we need to parse the viewbox on the svg
root tag to determine the size of the pages. more info in the 
<a href="http://idpf.org/epub/fxl/#dimensions-xhtml-svg">fixed layout spec</a></p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">parseViewboxTag</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The value of the ‘viewBox’ attribute is a list of four numbers 
<code>&lt;min-x&gt;</code>, <code>&lt;min-y&gt;</code>, <code>&lt;width&gt;</code> and <code>&lt;height&gt;</code>, separated by 
whitespace and/or a comma</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">dom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContentDom</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">viewboxString</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;viewBox&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>split on whitespace and/or comma</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">valuesArray</span> <span class="o">=</span> <span class="nx">viewboxString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/,?\s+|,/</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="nx">values</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">valuesArray</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
		<span class="nx">values</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">valuesArray</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">return</span> <span class="nx">values</span><span class="p">;</span>

	<span class="p">},</span>

	<span class="nx">resolvePath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="p">},</span>

	<span class="nx">resolveUri</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">resolveUri</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>	
	<span class="p">},</span>

	<span class="nx">isSvg</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;media_type&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;image/svg+xml&quot;</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">isImage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">media_type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;media_type&quot;</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="nx">media_type</span> <span class="o">&amp;&amp;</span> <span class="nx">media_type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;image/&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>we want to treat svg as a special case, so they
are not images</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">return</span> <span class="nx">media_type</span> <span class="o">!==</span> <span class="s2">&quot;image/svg+xml&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Load this content from the filesystem</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">loadContent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">));</span>
		
		<span class="nx">Readium</span><span class="p">.</span><span class="nx">FileSystemApi</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">api</span><span class="p">.</span><span class="nx">readTextFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span><span class="nx">content</span><span class="o">:</span> <span class="nx">result</span><span class="p">}</span> <span class="p">);</span>
			<span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Failed to load file: &quot;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">);</span>
			<span class="p">})</span>
		<span class="p">});</span>
	<span class="p">}</span>
	
<span class="p">});</span>

<span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">SpineItem</span> <span class="o">=</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ManifestItem</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isFixedLayout</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:content&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseMetaTags</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">loadContent</span><span class="p">();</span>
		<span class="p">}</span>
		
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>this method creates the JSON representation of a manifest item
that is used to render out a page view.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">buildSectionJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">manifest_item</span><span class="p">,</span> <span class="nx">spine_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">manifest_item</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">section</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
		<span class="nx">section</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_width&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nx">section</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nx">section</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">resolveUri</span><span class="p">(</span><span class="nx">manifest_item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">));</span>
		<span class="nx">section</span><span class="p">.</span><span class="nx">page_class</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPageSpreadClass</span><span class="p">(</span><span class="nx">manifest_item</span><span class="p">,</span> <span class="nx">spine_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="nx">section</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isFixedLayout</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">parseMetaTags</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="nx">json</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_width&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nx">json</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nx">json</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveUri</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">));</span>
		<span class="nx">json</span><span class="p">.</span><span class="nx">page_class</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPageSpreadClass</span><span class="p">();</span>
		<span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>when rendering fixed layout pages we need to determine whether the page
should be on the left or the right in two up mode, options are:
    left<em>page:      render on the left side
right</em>page:     render on the right side
center_page:     always center the page horizontally</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">getPageSpreadClass</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;book&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">spine_index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_index&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">pageSpreadProperty</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;apple_fixed&quot;</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>the logic for apple fixed layout is a little different:</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="cm">/*</span>
<span class="cm">			if(!book.get(&quot;open_to_spread&quot;)) {</span>

<span class="cm">//DIVIDER</span>
<span class="cm">				return	&quot;center_page&quot;</span>
<span class="cm">			}</span>
<span class="cm">			else if(spine_index === 0) {</span>
<span class="cm">				*/</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">spine_index</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>page spread is disabled for this book</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span> <span class="s2">&quot;center_page&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">spine_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> 
				<span class="nx">spine_index</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>for ibooks, odd pages go on the right. This means
the first page (0th index) will always be on the right
without a left counterpart, so center it</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span> <span class="s2">&quot;center_page&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>if the last spine item in the book would be on the left, then
it would have no left counterpart, so center it</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span> <span class="p">(</span><span class="nx">spine_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;right_page&quot;</span> <span class="o">:</span> <span class="s2">&quot;left_page&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>otherwise first page goes on the right, and then alternate
left - right - left - right etc</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;page_spread&quot;</span><span class="p">))</span> <span class="p">{</span>

				<span class="nx">pageSpreadProperty</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;page_spread&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">pageSpreadProperty</span> <span class="o">===</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">return</span> <span class="s2">&quot;left_page&quot;</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pageSpreadProperty</span> <span class="o">===</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">return</span> <span class="s2">&quot;right_page&quot;</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>

					<span class="k">return</span> <span class="s2">&quot;center_page&quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>If the page spread property has been set for this spine item, return 
the name of the appropriate spread class. 
Note: As there are only three valid values (left, right, center) for the page
spread property in ePub 3.0, if the property is set and 
it is not "left" or "right, "center" will always be assumed. </p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>If the page spread property is not set, use a even/odd page index heuristic that depends on the 
page progression order:
  - Even-numbered pages on the right for rtl text
  - Odd-numbered pages on the left for ltr text</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;page_prog_dir&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;rtl&quot;</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">return</span> <span class="p">(</span><span class="nx">spine_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;right_page&quot;</span> <span class="o">:</span> <span class="s2">&quot;left_page&quot;</span><span class="p">);</span>
				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Check for right-to-left page progression direction</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">else</span> <span class="p">{</span>

					<span class="k">return</span> <span class="p">(</span><span class="nx">spine_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;left_page&quot;</span> <span class="o">:</span> <span class="s2">&quot;right_page&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">isFixedLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Text is left-to-right</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isSvg</span><span class="p">()</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isImage</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>if it an svg or image then it is fixed layout</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;fixed_flow&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;fixed_flow&#39;</span><span class="p">);</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>if there is a fixed_flow property, then it takes precedence</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">isBookFixedLayout</span><span class="p">();</span>
	<span class="p">},</span>

	<span class="nx">getPageView</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">FixedPageView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">});</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>
	<span class="p">},</span>
    
    <span class="nx">hasMediaOverlay</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;media_overlay&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">getMediaOverlay</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="nx">getMediaOverlay</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getMediaOverlay</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;media_overlay&quot;</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">});</span>



<span class="nx">Readium</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">ManifestItems</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">model</span><span class="o">:</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ManifestItem</span><span class="p">,</span>

	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">;</span>   
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Readium</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">Spine</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">model</span><span class="o">:</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">SpineItem</span><span class="p">,</span>

	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">isBookFixedLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;book&quot;</span><span class="p">).</span><span class="nx">isFixedLayout</span><span class="p">();</span>
	<span class="p">},</span>

	<span class="nx">getMediaOverlay</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getMediaOverlayItem</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>nothing special about this spine item, fall back to the books settings</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 