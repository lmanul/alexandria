<!DOCTYPE html>  <html> <head>   <title>epub_controller.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="plugins.html">                 plugins.js               </a>                                           <a class="source" href="web_plugins.html">                 web_plugins.js               </a>                                           <a class="source" href="alternate_style_tag_selector.html">                 alternate_style_tag_selector.js               </a>                                           <a class="source" href="audioClipPlayer.html">                 audioClipPlayer.js               </a>                                           <a class="source" href="epub.html">                 epub.js               </a>                                           <a class="source" href="epub_controller.html">                 epub_controller.js               </a>                                           <a class="source" href="ibooks_options_parser.html">                 ibooks_options_parser.js               </a>                                           <a class="source" href="manifest_item.html">                 manifest_item.js               </a>                                           <a class="source" href="mediaOverlay.html">                 mediaOverlay.js               </a>                                           <a class="source" href="options_presenter.html">                 options_presenter.js               </a>                                           <a class="source" href="packageDocument.html">                 packageDocument.js               </a>                                           <a class="source" href="package_document_parser.html">                 package_document_parser.js               </a>                                           <a class="source" href="page_number_display_logic.html">                 page_number_display_logic.js               </a>                                           <a class="source" href="pagination_strategy_selector.html">                 pagination_strategy_selector.js               </a>                                           <a class="source" href="path_resolver.html">                 path_resolver.js               </a>                                           <a class="source" href="readium_options.html">                 readium_options.js               </a>                                           <a class="source" href="readium_pagination.html">                 readium_pagination.js               </a>                                           <a class="source" href="smilModel.html">                 smilModel.js               </a>                                           <a class="source" href="toc.html">                 toc.js               </a>                                           <a class="source" href="trigger.html">                 trigger.js               </a>                                           <a class="source" href="validated_package_meta_data.html">                 validated_package_meta_data.js               </a>                                           <a class="source" href="crx_library_namespace.html">                 crx_library_namespace.js               </a>                                           <a class="source" href="crx_viewer_namespace.html">                 crx_viewer_namespace.js               </a>                                           <a class="source" href="ws_lib_namespace.html">                 ws_lib_namespace.js               </a>                                           <a class="source" href="crx_library_router.html">                 crx_library_router.js               </a>                                           <a class="source" href="crx_viewer_router.html">                 crx_viewer_router.js               </a>                                           <a class="source" href="ws_router.html">                 ws_router.js               </a>                                           <a class="source" href="bb_file_system_sync.html">                 bb_file_system_sync.js               </a>                                           <a class="source" href="cookie_utils.html">                 cookie_utils.js               </a>                                           <a class="source" href="handlebars_helpers.html">                 handlebars_helpers.js               </a>                                           <a class="source" href="local_storage_sync.html">                 local_storage_sync.js               </a>                                           <a class="source" href="md5.html">                 md5.js               </a>                                           <a class="source" href="user_agent_utils.html">                 user_agent_utils.js               </a>                                           <a class="source" href="nav_widget_view.html">                 nav_widget_view.js               </a>                                           <a class="source" href="options_view.html">                 options_view.js               </a>                                           <a class="source" href="toc_view.html">                 toc_view.js               </a>                                           <a class="source" href="toolbar_view.html">                 toolbar_view.js               </a>                                           <a class="source" href="httpFileApi.html">                 httpFileApi.js               </a>                                           <a class="source" href="library.html">                 library.js               </a>                                           <a class="source" href="viewer.html">                 viewer.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               epub_controller.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Description: This model is a sort of "controller" for an ePUB, managing the interaction between calling code
  and the saved epub. This model also exposes and persists properties that determine how an epub is displayed in 
  Readium. Some of these properties are determined by the user, such as whether two pages are being displayed, the font size etc.
  Other properties are determined by the user's interaction with the reader and the structure of the book. These include
  the current spine item rendered in the viewer, as well the logic that governs changing the current spine item.  </p>

<p>Rationale: This model is designed to expose a useful concept of an "epub" to the rest of Readium. This includes the contents
  of the epub itself, as well as view properties (mentioned above) and the logic governing interaction with epub properties and 
  contents. It is the intention for this model that it have little to no knowledge of how an epub is rendered. It is intended 
  that Backbone attributes (getting/setting) and the backbone attribute event model (events fired on attribute changes) should 
  the primary ways of interacting with this model.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">EPUBController</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>------------------------------------------------------------------------------------ //
 "PUBLIC" METHODS (THE API)                                                          //
------------------------------------------------------------------------------------ //</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>capture context for use in callback functions</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">epub</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epub&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>create a <a href="/docs/paginator.html"><code>Paginator</code></a> object used to initialize
pagination strategies for the spine items of this book</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">paginator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PaginationStrategySelector</span><span class="p">({</span><span class="nx">book</span><span class="o">:</span> <span class="k">this</span><span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Get the epub package document</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">getPackageDocument</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>TODO: this might have to change: Should this model load the package document or epub_state??
load the <code>packageDocument</code> from the HTML5 filesystem asynchroniously</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>success callback is executed once the filesSystem contents have 
been read and parsed</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>restore the position the reader left off at from cookie storage</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">restorePosition</span><span class="p">();</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>tell the paginator to start rendering spine items from the 
freshly restored position</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">items</span><span class="p">);</span>
				</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>check if a TOC is specified in the <code>packageDocument</code></p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;has_toc&quot;</span><span class="p">,</span> <span class="p">(</span> <span class="o">!!</span><span class="nx">that</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getTocItem</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>change:spine_position</code> is triggered whenver the reader turns pages
accross a <code>spine_item</code> boundary. We need to cache thier new position
and </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:spine_position&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">savePosition</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If we encounter a new fixed layout section, we need to parse the 
<code>&lt;meta name="viewport"&gt;</code> to determine the size of the iframe</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:spine_position&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Description: Persists the attributes of this model
Arguments (
  attrs: doesn't appear to be used
  options: 
)
Rationale: Each epub unpacked and saved to the filesystem in Readium has a unique
  key. "_epubViewProperties" is appended to this unique key to persist the read/write
  attributes separately from the read-only attributes of the epub.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">save</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>TODO: this should be done properly with a backbone sync</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">ops</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
		<span class="p">}</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ops</span><span class="p">,</span><span class="nx">options</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Set attributes required to persist the epub-specific viewer properties</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_epubViewProperties&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Persist viewer properties</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">Lawnchair</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">ops</span><span class="p">.</span><span class="nx">success</span><span class="p">);</span>
		<span class="p">});</span>
	<span class="p">},</span>

	<span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
		<span class="s2">&quot;font_size&quot;</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    	<span class="s2">&quot;two_up&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;full_screen&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;toolbar_visible&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    	<span class="s2">&quot;toc_visible&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;can_two_up&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    	<span class="s2">&quot;rendered_spine_items&quot;</span><span class="o">:</span> <span class="p">[],</span>
    	<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="s2">&quot;default-theme&quot;</span><span class="p">,</span>
    	<span class="s2">&quot;current_margin&quot;</span><span class="o">:</span> <span class="mi">3</span>
  	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Description: serialize this models state to <code>JSON</code> so that it can
  be persisted and restored</p>             </td>             <td class="code">               <div class="highlight"><pre>  	<span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>only save attrs that should be persisted:</p>             </td>             <td class="code">               <div class="highlight"><pre>  		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_theme&quot;</span><span class="p">),</span>
			<span class="s2">&quot;updated_at&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">),</span>
			<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_theme&quot;</span><span class="p">),</span>
			<span class="s2">&quot;current_margin&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_margin&quot;</span><span class="p">),</span>
			<span class="s2">&quot;font_size&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">),</span>
			<span class="s2">&quot;two_up&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">),</span>
			<span class="s2">&quot;font_size&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">),</span>
			<span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
		<span class="p">};</span>
	<span class="p">},</span>

	<span class="nx">toggleFullScreen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">fullScreen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;full_screen&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">full_screen</span><span class="o">:</span> <span class="o">!</span><span class="nx">fullScreen</span><span class="p">});</span>
	<span class="p">},</span>

	<span class="nx">increaseFont</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">font_size</span><span class="o">:</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
	<span class="p">},</span>

	<span class="nx">decreaseFont</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">font_size</span><span class="o">:</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
	<span class="p">},</span>

	<span class="nx">toggleToc</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;toc_visible&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;toc_visible&quot;</span><span class="p">,</span> <span class="o">!</span><span class="nx">vis</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Description: Obtains the href and hash (if it exists) to set as the current "position"
   of the epub. Any views and models listening to epub attributes are informed through
   the backbone event broadcast.
Arguments (
  href (URL): The url and hash fragment that indicates the position in the epub to set as
  the epub's current position.
)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">goToHref</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>URL's with hash fragments require special treatment, so
first thing is to split off the hash frag from the rest
of the url:</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">splitUrl</span> <span class="o">=</span> <span class="nx">href</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([^#]*)(?:#(.*))?/</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>handle the base url first:</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">spine_pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineIndexFromHref</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">spine_pos</span><span class="p">);</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>now try to handle the fragment if there was one,</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>just set observable property to broadcast event
to anyone who cares</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">hash_fragment</span><span class="o">:</span> <span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]});</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">getToc</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getTocItem</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Toc</span><span class="p">.</span><span class="nx">getToc</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="p">{</span>
				<span class="nx">file_path</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)),</span>
				<span class="nx">book</span><span class="o">:</span> <span class="nx">that</span>
			<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Info: "Section" actually refers to a spine item</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">getCurrentSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">spine_pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getSpineItem</span><span class="p">(</span><span class="nx">spine_pos</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: this should be renamed to indicate it applies to the entire epub.
  This is only passing through this data to avoid breaking code in viewer.js. Eventually
  this should probably be removed. </p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">isFixedLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">isFixedLayout</span><span class="p">();</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>------------------------------------------------------------------------------------ //
 "PRIVATE" HELPERS                                                                   //
------------------------------------------------------------------------------------ //</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">restorePosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">getCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">savePosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">Readium</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">),</span> <span class="mi">365</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">resolvePath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">hasNextSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineLength</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">hasPrevSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">},</span>
	
	<span class="nx">goToNextSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasNextSection</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	
	<span class="nx">goToPrevSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPrevSection</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>	
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Description: Sets the current spine position for the epub, checking if the spine
  item is already rendered.
Arguments (
 pos (integer): The index of the spine element to set as the current spine position
)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">setSpinePos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">goToLastPageOfSection</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>check for invalid spine position</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineLength</span><span class="p">())</span> <span class="p">{</span>
			
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">spineItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">spinePosIsRendered</span> <span class="o">=</span> <span class="nx">spineItems</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: There is a somewhat hidden dependency here between the paginator
  and the setting of the spine<em>position. The paginator re-renders based on the currently
  set spine</em>position on this model; the paginator has a reference to this model, which is 
  how it accesses the new spine<em>position. This would be clearer if the spine</em>position to set were passed 
  explicitly to the paginator. </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: This event should only be triggered for fixed layout sections</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;FXL_goToPage&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Render the new spine position if it is not already rendered. </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">spinePosIsRendered</span><span class="p">)</span> <span class="p">{</span>

			<span class="kd">var</span> <span class="nx">renderedItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="nx">goToLastPageOfSection</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">renderedItems</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">setMetaSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;change:meta_height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentSection</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;meta_size&quot;</span><span class="p">,</span> <span class="p">{</span>
				<span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_width&quot;</span><span class="p">),</span>
				<span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">)</span>
			<span class="p">});</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:meta_height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 