var Lawnchair=function(b,a){if(!(this instanceof Lawnchair))return new Lawnchair(b,a);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0)a=typeof arguments[0]==="function"?arguments[0]:arguments[1],b=typeof arguments[0]==="function"?{}:arguments[0];else throw"Incorrect # of ctor args!";if(typeof a!=="function")throw"No callback was provided";this.record=b.record||"record";this.name=b.name||"records";var e;if(b.adapter)for(var c=
0,d=Lawnchair.adapters.length;c<d;c++){if(Lawnchair.adapters[c].adapter===b.adapter){e=Lawnchair.adapters[c].valid()?Lawnchair.adapters[c]:void 0;break}}else{c=0;for(d=Lawnchair.adapters.length;c<d;c++)if(e=Lawnchair.adapters[c].valid()?Lawnchair.adapters[c]:void 0)break}if(!e)throw"No valid adapter.";for(var f in e)this[f]=e[f];c=0;for(d=Lawnchair.plugins.length;c<d;c++)Lawnchair.plugins[c].call(this);this.init(b,a)};Lawnchair.adapters=[];
Lawnchair.adapter=function(b,a){a.adapter=b;var e="adapter valid init keys save batch get exists all remove nuke".split(" "),c=this.prototype.indexOf,d;for(d in a)if(c(e,d)===-1)throw"Invalid adapter! Nonstandard method: "+d;Lawnchair.adapters.push(a)};Lawnchair.plugins=[];Lawnchair.plugin=function(b){for(var a in b)a==="init"?Lawnchair.plugins.push(b[a]):this.prototype[a]=b[a]};
Lawnchair.prototype={isArray:Array.isArray||function(b){return Object.prototype.toString.call(b)==="[object Array]"},indexOf:function(b,a,e,c){if(b.indexOf)return b.indexOf(a);for(e=0,c=b.length;e<c;e++)if(b[e]===a)return e;return-1},lambda:function(b){return this.fn(this.record,b)},fn:function(b,a){return typeof a=="string"?new Function(b,a):a},uuid:function(){var b=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b()},each:function(b){var a=
this.lambda(b);if(this.__results)for(var b=0,e=this.__results.length;b<e;b++)a.call(this,this.__results[b],b);else this.all(function(c){for(var b=0,e=c.length;b<e;b++)a.call(this,c[b],b)});return this}};
Lawnchair.adapter("webkit-sqlite",function(){var b=function(a,b){console.log("error in sqlite adaptor!",a,b)};if(!Function.prototype.bind)Function.prototype.bind=function(b){var e=[].slice,c=e.call(arguments,1),d=this,f=function(){},g=function(){return d.apply(this instanceof f?this:b||{},c.concat(e.call(arguments)))};f.prototype=d.prototype;g.prototype=new f;return g};return{valid:function(){return!!window.openDatabase},init:function(a,e){var c=this,d=c.fn(c.name,e),f="CREATE TABLE IF NOT EXISTS "+
this.name+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",g=function(){return d.call(c,c)};this.db=openDatabase(this.name,"1.0.0",this.name,65536);this.db.transaction(function(c){c.executeSql(f,[],g,b)})},keys:function(a){var e=this.lambda(a),c=this,d="SELECT id FROM "+this.name+" ORDER BY timestamp DESC";this.db.transaction(function(a){a.executeSql(d,[],function(b,a){if(a.rows.length==0)e.call(c,[]);else{for(var d=[],f=0,j=a.rows.length;f<j;f++)d.push(a.rows.item(f).id);e.call(c,
d)}},b)});return this},save:function(a,e){var c=this,d=a.key||c.uuid(),f="INSERT INTO "+this.name+" (value, timestamp, id) VALUES (?,?,?)",g="UPDATE "+this.name+" SET value=?, timestamp=? WHERE id=?",k=function(){if(e)a.key=d,c.lambda(e).call(c,a)},h=[new Date,d];c.exists(a.key,function(e){c.db.transaction(function(c){var d=function(a){delete a.key;h.unshift(JSON.stringify(a));c.executeSql(g,h,k,b)};e?d(a):(h.unshift(JSON.stringify(a)),c.executeSql(f,h,k,b))})});return this},batch:function(a,b){for(var c=
[],d=!1,f=this,g=function(b){c.push(b);d=c.length===a.length},k=setInterval(function(){d&&(b&&f.lambda(b).call(f,c),clearInterval(k))},200),h=0,i=a.length;h<i;h++)this.save(a[h],g);return this},get:function(a,e){var c=this,d="",d=this.isArray(a)?"SELECT id, value FROM "+this.name+" WHERE id IN ('"+a.join("','")+"')":"SELECT id, value FROM "+this.name+" WHERE id = '"+a+"'",f=function(b,d){var f=null,i=[];if(d.rows.length)for(var j=0,l=d.rows.length;j<l;j++)f=JSON.parse(d.rows.item(j).value),f.key=
d.rows.item(j).id,i.push(f);c.isArray(a)||(i=i.length?i[0]:null);e&&c.lambda(e).call(c,i)};this.db.transaction(function(a){a.executeSql(d,[],f,b)});return this},exists:function(a,e){var c="SELECT * FROM "+this.name+" WHERE id = ?",d=this,f=function(b,a){e&&d.fn("exists",e).call(d,a.rows.length>0)};this.db.transaction(function(d){d.executeSql(c,[a],f,b)});return this},all:function(a){var e=this,c="SELECT * FROM "+this.name,d=[],f=this.fn(this.name,a)||void 0,g=function(a,b){if(b.rows.length!=0)for(var c=
0,g=b.rows.length;c<g;c++){var l=JSON.parse(b.rows.item(c).value);l.key=b.rows.item(c).id;d.push(l)}f&&f.call(e,d)};this.db.transaction(function(a){a.executeSql(c,[],g,b)});return this},remove:function(a,e){var c=this,d=typeof a==="string"?a:a.key,f="DELETE FROM "+this.name+" WHERE id = ?",g=function(){e&&c.lambda(e).call(c)};this.db.transaction(function(a){a.executeSql(f,[d],g,b)});return this},nuke:function(a){var e="DELETE FROM "+this.name,c=this,d=a?function(){c.lambda(a).call(c)}:function(){};
this.db.transaction(function(a){a.executeSql(e,[],d,b)});return this}}}());
